// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =========================================================
// AUTH & USER MANAGEMENT (Keep existing)
// =========================================================

enum Role {
  SUPERADMIN
  STAFF
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          String    @default("STAFF")
  posts         Post[]
  sessions      Session[]
  accounts      Account[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// =========================================================
// MASTER DATA (Updated)
// =========================================================

model Product {
  id          BigInt      @id @default(autoincrement())
  name        String
  type        ProductType // raw, finished
  description String?
  image       String?
  unit        String
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  purchaseItems     PurchaseItem[]
  saleItems         SaleItem[]
  productionInputs  ProductionInput[]
  productionOutputs ProductionOutput[]
  stockMovements    StockMovement[]

  @@map("products")
}

model Worker {
  id       BigInt  @id @default(autoincrement())
  name     String
  role     String?
  isActive Boolean @default(true) @map("is_active")

  // Relations
  productionWorkers ProductionWorker[]

  @@map("workers")
}

model ProductionType {
  id          BigInt  @id @default(autoincrement())
  name        String  @unique
  description String?
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  productions Production[]

  @@map("production_types")
}

// Reuse Customer model but update ID to BigInt to match relations
// Customer model removed; supplier/buyer now use manual string IDs

// =========================================================
// TRANSACTIONS (New)
// =========================================================

// 2. PEMBELIAN
model Purchase {
  id         BigInt            @id @default(autoincrement())
  supplier   String?           
  date       DateTime          @db.Date
  status     TransactionStatus // draft, posted, cancelled
  notes      String?
  revokedAt    DateTime?      @map("revoked_at")
  revokedById  String?        @map("revoked_by_id")
  revokeReason String?        @map("revoke_reason")

  // Relations
  purchaseItems PurchaseItem[]

  @@map("purchases")
}

model PurchaseItem {
  id         BigInt  @id @default(autoincrement())
  purchaseId BigInt  @map("purchase_id")
  productId  BigInt  @map("product_id")
  qty        Decimal @db.Decimal(14, 4)
  unitCost   Decimal @db.Decimal(14, 4) @map("unit_cost")

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

// 3. PENJUALAN
model Sale {
  id         BigInt            @id @default(autoincrement())
  customer   String?           
  date       DateTime          @db.Date
  status     TransactionStatus // draft, posted, cancelled
  notes      String?
  revokedAt    DateTime?      @map("revoked_at")
  revokedById  String?        @map("revoked_by_id")
  revokeReason String?        @map("revoke_reason")

  // Relations
  saleItems SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        BigInt  @id @default(autoincrement())
  saleId    BigInt  @map("sale_id")
  productId BigInt  @map("product_id")
  qty       Decimal @db.Decimal(14, 4)
  unitPrice Decimal @db.Decimal(14, 4) @map("unit_price")

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

// 4. PRODUKSI
model Production {
  id               BigInt           @id @default(autoincrement())
  productionTypeId BigInt           @map("production_type_id")
  date             DateTime         @db.Date
  status           ProductionStatus // draft, completed, cancelled
  notes            String?
  revokedAt    DateTime?      @map("revoked_at")
  revokedById  String?        @map("revoked_by_id")
  revokeReason String?        @map("revoke_reason")

  // Relations
  productionType    ProductionType     @relation(fields: [productionTypeId], references: [id])
  productionInputs  ProductionInput[]
  productionOutputs ProductionOutput[]
  productionWorkers ProductionWorker[]

  @@map("productions")
}

model ProductionInput {
  id           BigInt  @id @default(autoincrement())
  productionId BigInt  @map("production_id")
  productId    BigInt  @map("product_id")
  qty          Decimal @db.Decimal(14, 4)
  unitCost     Decimal @db.Decimal(14, 4) @map("unit_cost")

  // Relations
  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@map("production_inputs")
}

model ProductionOutput {
  id           BigInt  @id @default(autoincrement())
  productionId BigInt  @map("production_id")
  productId    BigInt  @map("product_id")
  qty          Decimal @db.Decimal(14, 4)
  unitCost     Decimal @db.Decimal(14, 4) @map("unit_cost")

  // Relations
  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@map("production_outputs")
}

model ProductionWorker {
  id           BigInt   @id @default(autoincrement())
  productionId BigInt   @map("production_id")
  workerId     BigInt   @map("worker_id")
  role         String?
  hours        Decimal? @db.Decimal(10, 2)

  // Relations
  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  worker     Worker     @relation(fields: [workerId], references: [id])

  @@map("production_workers")
}

// 5. MUTASI STOK
model StockMovement {
  id         BigInt   @id @default(autoincrement())
  productId  BigInt   @map("product_id")
  qty        Decimal  @db.Decimal(14, 4)
  sourceType String   @map("source_type") // purchase_item, sale_item, production_input, production_output
  sourceId   BigInt   @map("source_id")
  displayUnit String? 
  conversionRateUsed Decimal? @db.Decimal(14, 6) @map("conversion_rate_used")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@index([productId], name: "idx_stock_movements_product")
  @@index([sourceType, sourceId], name: "idx_stock_movements_source")
  @@map("stock_movements")
}

// 6. PENGIKISAN
model Pengikisan {
  id        BigInt            @id @default(autoincrement())
  date      DateTime          @db.Date
  notes     String?
  totalUpah Decimal?          @db.Decimal(14, 2) @map("total_upah")

  pengikisanItems PengikisanItem[]

  @@map("pengikisan")
}

model PengikisanItem {
  id           BigInt   @id @default(autoincrement())
  pengikisanId BigInt   @map("pengikisan_id")
  nama         String
  kaKg         Decimal  @db.Decimal(14, 4) @map("ka_kg")
  stikKg       Decimal  @db.Decimal(14, 4) @map("stik_kg")
  upahKa       Decimal  @db.Decimal(14, 2) @map("upah_ka")
  upahStik     Decimal  @db.Decimal(14, 2) @map("upah_stik")
  total        Decimal  @db.Decimal(14, 2)

  pengikisan Pengikisan @relation(fields: [pengikisanId], references: [id], onDelete: Cascade)

  @@map("pengikisan_items")
}

// =========================================================
// CMS / WEBSITE (Keep existing)
// =========================================================

model Inquiry {
  id        String        @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String
  status    InquiryStatus @default(NEW)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("inquiry")
}

model Post {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String
  image     String?
  published Boolean  @default(false)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("post")
}

model ContactInfo {
  id        String   @id @default(cuid())
  address   String?
  phone     String?
  email     String?
  whatsapp  String?
  updatedAt DateTime @updatedAt

  @@map("contact_info")
}

model SocialMedia {
  id        String   @id @default(cuid())
  platform  String
  url       String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("social_media")
}

// =========================================================
// CMS - HOME PAGE
// =========================================================

model HeroSlide {
  id          String       @id @default(cuid())
  type        String       // "image" | "video"
  src         String
  title       String
  description String
  order       Int          @default(0)
  buttons     HeroButton[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("hero_slides")
}

model HeroButton {
  id        String    @id @default(cuid())
  text      String
  href      String
  isPrimary Boolean   @default(false)
  slideId   String
  slide     HeroSlide @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@map("hero_buttons")
}

model HomePage {
  id               String   @id @default(cuid())
  aboutTitle       String
  aboutDescription String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("home_page")
}

// =========================================================
// CMS - ABOUT PAGE
// =========================================================

model AboutPage {
  id              String       @id @default(cuid())
  heroTitle       String
  heroDescription String
  mainTitle       String
  mainDescription String       @db.Text
  mainImage       String
  points          AboutPoint[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("about_page")
}

model AboutPoint {
  id          String    @id @default(cuid())
  text        String
  aboutPageId String
  aboutPage   AboutPage @relation(fields: [aboutPageId], references: [id], onDelete: Cascade)
  order       Int       @default(0)

  @@map("about_points")
}

// =========================================================
// CMS - SHARED / GENERIC SECTIONS
// =========================================================

model FeatureCard {
  id          String   @id @default(cuid())
  section     String   // "HOME_ABOUT" | "ABOUT_VALUES"
  title       String
  description String
  icon        String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("feature_cards")
}

// =========================================================
// ENUMS
// =========================================================

enum InquiryStatus {
  NEW
  READ
  REPLIED
}

enum ProductType {
  raw
  finished
}

enum TransactionStatus {
  draft
  posted
  cancelled
}

enum ProductionStatus {
  draft
  completed
  cancelled
}
